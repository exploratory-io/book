const template = `

選択された説明変数を元に、<%= target %>を予測する決定木のモデルを作成しました。

# 変数間の関係

<% if (predictorColumns.length > 1) { %>
## 変数の重要度

<%= target %>を予測するためにどの説明変数が相対的により重要なのかを表したのが以下のチャートです。

{{variable_importance}}

変数の重要度の仕組みについては、[こちら](https://exploratory.io/note/exploratory/dLm5rwn5)のノートをご覧ください。

<% } %>


## 変数の影響度

<% if (predictorColumns.length > 1) { %>
それぞれの説明変数の値が変わると<%= target %>の値がどのように変わるかを表したのが以下のチャートです。
<% } else { %>
説明変数の値が変わると<%= target %>の値がどのように変わるかを表したのが以下のチャートです。
<% } %>

{{variable_effect}}

* 青い線（または点）は説明変数の値に対する予測値を示します。
* グレーの線は実測値とその95%信頼区間を示します。
* 縦軸は<%= target %>の値です。

注意点：

<% if (predictorColumns.length > 1) { %>

* 他の変数が一定だとした時に、その説明変数単体の効果を予測しているため、実測値の平均値と予測値にずれが生じます。
* 予測値の計算方法の詳細は、[こちらのノート](https://exploratory.io/note/exploratory/Sbd0LDU6)をご参照ください。
* 説明変数は上記の「説明変数の重要度」にある重要度の高い順番で並んでいます。

<% } %>

<% if (has_category_columns) { %>
* カテゴリー型（Character型、Factor型）の説明変数において一意の値が12個より多い場合は、頻度の多いものから11個の値を残し、それ以外は「その他」としています。これは[「設定」](//analytics/settings/max_categories_for_factor)より変更可能です。
<% } %>

# 決定木

データを下に作成された決定木（一連の条件分岐）を可視化したものが以下です。<%= target %>を予測する際に作られた条件分岐を確認することができます。

{{tree_structure}}

**決定木の読み方**

それぞれの箱はノードと呼ばれ、そこから伸びる線はブランチ（枝）と呼ばれます。

- **条件分岐**: 各ノードの下には条件（例：「変数A < 値X」）が表示されており、この条件に基づいて左右に分岐します。
 - 左側のブランチは条件が「yes（真）」の場合
 - 右側のブランチは条件が「no（偽）」の場合
- **ノード内の情報**
 - **上段**: 各ノードに含まれるデータの<%= target %>の平均値
 - **下段**: 各ノードに含まれるデータの全体に対する割合（%）

 一番下のノードの上段の値が決定木のモデルを使った際の予測値となります。

# モデルの指標

 <% if (test_mode) { %>
 モデルの予測精度に関する様々な指標を、以下の表にまとめています。現在テストモードであるため、予測精度に対してはトレーニングデータとテストデータ両方に対しての指標を表示しています。
 <% } else { %>
 モデルの予測精度に関する様々な指標を以下の表にまとめています。
 <% } %>

 {{summary}}

 行数はモデル作成に使用したデータの行数を示します。

## 予測精度

目的変数が数値型の場合、モデルの予測精度を評価する指標としてよく使われるのがR2乗とRMSEです。

* R2乗
  * R2乗は目的変数の値のばらつきのうち、このモデルに使われている説明変数によって説明される割合を示します。
  * 値は0から1の間で、1はモデルが完全に目的変数の値を予測できることを意味します。
  * 一般的に0.8以上で非常に高い、0.6～0.8で高い、0.4～0.6で中程度、0.2～0.4で低い、0.2未満で非常に低いモデル適合度と解釈されることが多いです。
  * R2乗について解説したノートは[こちら](https://exploratory.io/note/exploratory/R2-zVj7AqB3)をご覧ください。

* RMSE
  * RMSEは平均二乗誤差の平方根を表し、予測値と実測値の誤差の大きさを測定します。
  * 目的変数と同じ単位で表されるため解釈しやすく、値が小さいほど予測精度が高いことを意味します。
  * 0以上の値を取り、完璧な予測であれば0になります。
  * RMSEについて解説したノートは[こちら](https://exploratory.io/note/exploratory/RMSE-DjQ0KQd5)をご覧ください。


R2乗やRMSEの考え方や具体的な計算方法については、以下のノートをご覧ください。

* R2乗 - [解説ノート](https://exploratory.io/note/exploratory/R2-zVj7AqB3)
* RMSE - [解説ノート](https://exploratory.io/note/exploratory/RMSE-DjQ0KQd5)


{start_show_hide}
## その他の指標の説明

* R2乗
  * R2乗は目的変数の値のばらつきのうち、このモデルに使われている説明変数によって説明される割合を示します。
  * 値は0から1の間で、1はモデルが完全に目的変数の値を予測できることを意味します。
  * 一般的に0.8以上で非常に高い、0.6～0.8で高い、0.4～0.6で中程度、0.2～0.4で低い、0.2未満で非常に低いモデル適合度と解釈されることが多いです。
  * R2乗について解説したノートは[こちら](https://exploratory.io/note/exploratory/R2-zVj7AqB3)をご覧ください。

* RMSE
  * RMSEは平均二乗誤差の平方根を表し、予測値と実測値の誤差の大きさを測定します。
  * 目的変数と同じ単位で表されるため解釈しやすく、値が小さいほど予測精度が高いことを意味します。
  * 0以上の値を取り、完璧な予測であれば0になります。
  * RMSEについて解説したノートは[こちら](https://exploratory.io/note/exploratory/RMSE-DjQ0KQd5)をご覧ください。

* 行数
  * 行数は分析に使用したデータの総数（サンプルサイズ）を示します。
  * サンプルサイズが大きいほど、統計的検定の検出力が高まり、結果の信頼性が向上します。
  * 説明変数にある数値型の列で欠損値が含まれている場合、その行が取り除かれて実行されます。

{end_show_hide}

## 実測値と予測値の関係

<% if (!test_mode) { %>
予測した結果、元の実測値と予測値にはズレがありますが、それらの関係を散布図を使って可視化したのが以下のチャートです。それぞれの点はそれぞれの行を表しています。
<% } else { %>
予測した結果、元の実測値と予測値にはズレがありますが、それらの関係を散布図を使って可視化したのが以下のチャートです。それぞれの点はそれぞれの行を表しています。トレーニングデータは青色に、テストデータはオレンジ色として分けて可視化しています。
<% } %>

{start_lazy_show_hide}
### チャート
{{actual_predicted}}
{end_lazy_show_hide}

## 予測結果

全データに対して、作成された予測モデルを使って予測した結果が以下の表となります。

{start_lazy_show_hide}
### テーブル
{{data}}
{end_lazy_show_hide}

# 補足情報

## 次のステップ

* 変数選択の最適化：変数重要度が低い説明変数を除外して、モデルをシンプルにすることを検討してください。これにより、モデルの解釈がしやすくなり、過剰適合のリスクも減少します。変数選択のガイドラインは[こちら](https://exploratory.io/note/exploratory/SWF4cTx8)のノートをご覧ください。
* 外れ値の確認：予測精度に影響を与える可能性のある外れ値がないか確認し、必要に応じて対処することで、モデルの信頼性が向上する可能性があります。外れ値を除去する方法については、[こちら](https://exploratory.io/note/exploratory/Eep7kip3)のノートをご覧ください。
* パラメータの調整：決定木のパラメータ（木の深さ、分岐による改善率の最小値など）を調整することで、モデルの性能をさらに向上させることができるかもしれません。
* アンサンブル学習の手法の検討：単一の決定木では捉えられないパターンを捉えるために、ランダムフォレストやXGBoostといったアンサンブル学習の手法を検討することも有効かもしれません。
<% if (!test_mode) { %>
* モデルの評価：このモデルの予測性能をより厳密に評価するために、トレーニングデータとテストデータに分けて検証することができます。その場合は、[「設定」](//analytics/settings)より「検証」セクションの下の「テストモード」をTRUEに設定し、実行し直してください。
<% } %>
* 新しいデータに対する予測：作成したモデルを使って新しいデータに対して予測をしたいときには、予測をしたい対象のデータフレームに「モデルで予測（アナリティクス・ビュー）」のステップを追加します。詳細は、[こちらのノート](https://exploratory.io/note/exploratory/AAI3Mle3)をご参照ください。

`;
module.exports = template;
