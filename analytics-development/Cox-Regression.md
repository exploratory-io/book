const template = `

選択された説明変数を元に、<%= event_status %>の生存曲線を予測するコックス回帰モデルを作成しました。

<% if (predictorColumns.length > 1) { %>
# 多重共線性

<% if (has_perfect_collinearity) { %>
{{multicollinearity:0.6}}

このモデルでは<%= perfect_collinearity_variables %>が完全な[多重共線性](https://exploratory.io/note/exploratory/Ysc3LNp0)（他の説明変数の値によって数式で完全に計算できる状態）の問題を作っているため、そのVIFスコアが無限大となり多重共線性をテストするためのチャートが生成できませんでした。多重共線性の問題を解決するために、<%= perfect_collinearity_variables %>を説明変数から除外し再実行してください。
<% } else if (max_vif > 10) { %>
{{multicollinearity}}
<% if (perfect_collinearity_groups && perfect_collinearity_groups.length > 0) { %>
<%= perfect_collinearity_groups.join(', ') %>は完全な[多重共線性](https://exploratory.io/note/exploratory/Ysc3LNp0)（他の説明変数の値によって数式で完全に計算できる状態）の問題を作っているため、そのVIFスコアが無限大となり多重共線性をテストするためのチャートが生成できませんでした。多重共線性の問題を解決するために、<%= perfect_collinearity_groups.join(', ') %>を説明変数から除外し再実行してください。
それ以外のグループではこのモデルには[多重共線性](https://exploratory.io/note/exploratory/Ysc3LNp0)（複数の説明変数間に強い相関関係があること）の問題が見られます。VIFの値が10を超えている説明変数があると、個々の変数の効果を正確に評価することが難しくなります。
この問題を解決するためには、VIFの値が10を超えている説明変数の中から必要性が低いものを1つずつ除外し、再実行し、VIFの値が10を超える説明変数がなくなるまで繰り返してください。
<% } else { %>
このモデルには[多重共線性](https://exploratory.io/note/exploratory/Ysc3LNp0)（複数の説明変数間に強い相関関係があること）の問題が見られます。VIFの値が10を超えている説明変数があると、個々の変数の効果を正確に評価することが難しくなります。
この問題を解決するためには、VIFの値が10を超えている説明変数の中から必要性が低いものを1つずつ除外し、再実行し、VIFの値が10を超える説明変数がなくなるまで繰り返してください。
<% } %>
<% } else { %>
{{multicollinearity}}
<% if (perfect_collinearity_groups && perfect_collinearity_groups.length > 0) { %>
<%= perfect_collinearity_groups.join(', ') %>は完全な[多重共線性](https://exploratory.io/note/exploratory/Ysc3LNp0)（他の説明変数の値によって数式で完全に計算できる状態）の問題を作っているため、そのVIFスコアが無限大となり多重共線性をテストするためのチャートが生成できませんでした。多重共線性の問題を解決するために、<%= perfect_collinearity_groups.join(', ') %>を説明変数から除外し再実行してください。
それ以外のグループではこのモデルには[多重共線性](https://exploratory.io/note/exploratory/Ysc3LNp0)（複数の説明変数間に強い相関関係があること）の問題は見られません。（VIFの値が10を超えている説明変数があると、個々の変数の効果を正確に評価することが難しくなります。）
<% } else { %>
このモデルには[多重共線性](https://exploratory.io/note/exploratory/Ysc3LNp0)（複数の説明変数間に強い相関関係があること）の問題は見られません。（VIFの値が10を超えている説明変数があると、個々の変数の効果を正確に評価することが難しくなります。）
<% } %>
<% } %>
<% } %>

# 生存曲線

モデルに基づいた説明変数ごとの生存曲線を表したのが以下のチャートです。この曲線は、時間の経過（単位は<%= time_unit%>）に伴う生存確率（イベントの非発生確率）の予測値を示しています。

{{survival_curve}}

# 変数間の関係

<% if (predictorColumns.length > 1) { %>
## 説明変数の重要度

<%= event_status %>に関する生存曲線を予測するために、どの説明変数が相対的により重要なのかを表したのが以下のチャートです。

{{variable_importance}}

変数の重要度の仕組みについては、[こちら](https://exploratory.io/note/exploratory/dLm5rwn5)のノートをご覧ください。

<% } %>

## 説明変数の影響度

<% if (predictorColumns.length > 1) { %>
期間が<%= survival_period%>の時点において、他の変数の値が一定であったとき、それぞれの説明変数の値が変わると<%= event_status %>の発生確率がどのように変わるかを表したのが以下のチャートです。期間は[「設定」](//analytics/settings/survival_period)より変更可能です。
<% } else { %>
期間が<%= survival_period%>の時点において、説明変数の値が変わると<%= event_status %>の発生確率がどのように変わるかを表したのが以下のチャートです。期間は[「設定」](//analytics/settings/survival_period)より変更可能です。
<% } %>

{{variable_effect}}

* 青い線（または点）は期間が<%= survival_period%>の時点において、説明変数の値に対する予測値を示します。
* グレーの線は実測値とその95%信頼区間を示します。

注意点：

<% if (predictorColumns.length > 1) { %>

* 他の変数が一定だとした時に、その説明変数単体の効果を予測しているため、実測値の平均値と予測値にずれが生じます。
* 予測値の計算方法の詳細は、[こちらのノート](https://exploratory.io/note/exploratory/Sbd0LDU6)をご参照ください。
* 単回帰分析と重回帰分析の解釈の違いについては、[こちらのノート](https://exploratory.io/note/exploratory/BDI7AeE5)をご覧ください。
* 説明変数は上記の「説明変数の重要度」にある重要度の高い順番で並んでいます。

<% } %>

<% if (has_category_columns) { %>
* カテゴリー型（Character型、Factor型）の説明変数において一意の値が<%= predictor_n %>個より多い場合は、頻度の多いものから<%= predictor_n -1 %>個の値を残し、それ以外は「その他」としています。これは[「設定」](//analytics/settings/max_categories_for_factor)より変更可能です。
<% } %>

# 変数のハザード比

変数ごとにハザード比とその有意性を判断するためのP値、および信頼区間がリストされています。

{{coefficient_table}}

## ハザード比の解釈

それぞれの説明変数の値が1単位変わると、<%= event_status %>のハザード（単位時間あたりに<%= event_status %>が発生するリスク）が何倍上がる（または下がる）かを示します。ハザードとは、ある時点でイベントが発生する瞬間的なリスク（発生率）を意味します。

**ハザード比の解釈の例**

<% variables.forEach(variable => { %>
<% if (variable.type == 'numeric') { %>
* 他の変数の値が一定の場合、<%= variable.variable %>が1単位上がると、<%= event_status %>のハザード（単位時間あたりに<%= event_status %>が発生するリスク：イベント発生率 / 生存率）は約<%= variable.hazard_ratio %>倍になります。
<% } else if (variable.type == 'logical') { %>
* 他の変数の値が一定の場合、<%= variable.variable %>がTRUEの場合、FALSEに比べて<%= event_status %>のハザード（単位時間あたりに<%= event_status %>が発生するリスク：イベント発生率 / 生存率）は約<%= variable.hazard_ratio %>倍になります。
<% } else { %>
* 他の変数の値が一定の場合、「<%= variable.variable %>」は、ベースレベルである「<%= variable.base_level %>」と比べて<%= event_status %>のハザード（単位時間あたりに<%= event_status %>が発生するリスク：イベント発生率 / 生存率）は約<%= variable.hazard_ratio %>倍になります。ベースレベルの詳細は[こちらのノート](https://exploratory.io/note/exploratory/Pxa6FmO2)をご参照ください。
<% } %>
<% }) %>

統計の予測モデルにおけるデータタイプごとの係数の解釈方法については、[こちら](https://exploratory.io/note/exploratory/KOC5WYt3)のノートをご覧ください。

## P値を使った有意性の判断

有意水準が<%= baseline_p_pct %>% (<%= baseline_p %>)の元では、P値が<%= baseline_p_pct %>% (<%= baseline_p %>)よりも大きい説明変数は生存曲線との関係が統計的に有意だとは言えません。逆に、P値が<%= baseline_p_pct %>% (<%= baseline_p %>)よりも小さい説明変数は生存曲線との関係が統計的に有意だと言えます。

_現在の有意水準（P値）は<%= baseline_p_pct %>% (<%= baseline_p %>)に設定されていますが、これは[「設定」](//analytics/settings)より変更可能です。_

## ハザード比と信頼区間の可視化

それぞれの変数のハザード比と有意性を可視化したのが以下のチャートです。

{{coefficient}}

* それぞれのエラーバーの真ん中の点はハザード比の値、上下の線はその95%信頼区間を表しています。生存曲線との関係が有意で、かつその関係が正の説明変数は赤、関係が負の説明変数は青となっています。グレーで表されている説明変数は生存曲線との関係が有意とは言えません。
* ハザード比が1であるということは、説明変数の値が変化しても、<%= event_status %>の発生リスク（単位時間あたりの発生率）に変化がないことを意味し、生存曲線との関係がないことを示します。
* ハザード比の95%信頼区間は、「真のハザード比がこの範囲内にある可能性が高い（95%の信頼がある）」ということを意味します。そのため、信頼区間が1を含んでいる説明変数は、生存曲線との関係が全くない可能性があるため、統計的に有意だとは言えません。逆に、信頼区間が1を含んでいない説明変数は、生存曲線との関係が全くない可能性はほぼないため、統計的に有意だと言えます。
* 有意性の判断はP値または信頼区間によって行うことができます。どちらで判断しても同じ結果となります。

_上記の信頼区間の説明は直感的な説明であって、正確には「同じ母集団から繰り返しサンプルを取り、毎回95％信頼区間を計算した場合、そのうちの95％の区間は真のハザード比を含む」ということになります。_

**注意点：**

* ハザード比は、確率の変化比ではなく、あくまでもハザード（単位時間あたりのイベント発生リスク）の変化比です。
* ハザード比が1より大きい場合は、<%= event_status %>がより早く（短い時間で）発生しやすくなり、1より小さい場合は発生しにくく（時間がかかるように）なります。
* これらのハザード比の値は、あくまでもそれぞれの説明変数の値が1単位変化した場合の相対的なリスクの変化を示すものであり、説明変数ごとにスケール（単位）が異なる場合、それらのハザード比の値を使って生存曲線との関係の強さを直接比較することはできません。説明変数間の影響の大きさを比較したい場合は、上記の「説明変数の重要度」をご参照ください。

# モデルの指標

<% if (!test_mode) { %>
モデルの予測精度や有意性に関する様々な指標を以下の表にまとめています。
<% } else { %>
モデルの予測精度や有意性に関する様々な指標を、以下の表にまとめています。現在テストモードであるため、予測精度に対してはトレーニングデータとテストデータ両方に対しての指標を表示しています。
<% } %>

{{summary_chart}}

## 予測精度の指標

* 一致係数
  * 一致係数はモデルの予測能力を示す指標で、ランダムに選んだ2つの観察対象（行）のうち、モデルが実際の生存時間の順序を正しく予測できる確率を表します。
  * 値は0.5から1の間で、0.5はランダム予測と同等、1は完璧な予測を意味します。
  * 一般的に0.7以上で許容可能、0.8以上で良好な予測性能と解釈されます。

* 時点AUC
  * 時点AUCは特定の時点において、このモデルがTRUEのデータとFALSEのデータをうまく分類することができるかを測る指標です。
  * 現在、予測期間は<%= survival_period%>となっているため、<%= survival_period%>経過時点での生存率の予測値が時点AUCの計算に使われています。期間は[「設定」](//analytics/settings/survival_period)より変更可能です。
  * 値は0.5から1の間で、0.5はランダムな予測（コイン投げと同等）、1はTRUEとFALSEのデータを完全に分類できることを意味します。
  * 一般的に0.6以上で許容範囲、0.8以上で良好、0.9以上で非常に優れた分類性能と解釈されます。
  * 複数の時点でのAUCを確認することで、モデルの予測性能の時間的安定性を評価できます。

* R2乗
  * コックス回帰におけるR2乗は、モデルによって説明されるイベント発生の変動割合を示します。
  * 値は0から1の間で、大きいほどモデルの説明力が高いことを示します。

* R2乗 (最大値)
  * R2乗の理論上の最大値を示し、データの特性から達成可能な最大の説明力を表します。
  * 実際のR2乗をこの値と比較することで、モデルの相対的な性能を評価できます。
  * 低い最大値は、データの打ち切りが多いことを示唆します。


## モデルの有意性の検定

モデルの有意性の検定のために3つの仮説検定を行いました。それぞれ以下のような特徴があります。

* 尤度比検定 - フルモデル（すべての変数を含む）と制限モデル（特定の変数を除く）の対数尤度の差に基づく検定。
* ログランク検定（スコア検定）- 制限モデルのみに基づいて検定統計量を計算する。回帰係数がゼロ（つまり変数がモデルに含まれていない）という仮定のもとで計算。
* ワルド検定 - 推定された回帰係数とその標準誤差の比（tまたはzに類似）に基づいて、各係数がゼロかどうかを検定。

尤度比検定が最も最も正確で信頼性が高いため、一般的によく使われます。

**それぞれの指標の説明**

* 尤度比統計量
  * 尤度比検定は、帰無モデル（予測変数なし）とフルモデル（予測変数あり）の対数尤度の差をもとにモデルの有意性を評価します。
  * 統計量が大きいほど、予測変数がモデルに有意に貢献している可能性が高いと判断されます。
  * カイ二乗分布に従い、自由度は予測変数の数に等しくなります。

* P値（尤度比検定）
  * 尤度比統計量に対応するP値は、モデル全体が統計的に有意かどうかを評価します。
  * 一般的に5%（0.05）未満であれば、統計的に有意であると判断できます。
  * P値が小さいほど、モデルに含まれる変数が有意である可能性が高いと解釈します。

* ログランク統計量（スコア統計量）
  * スコア検定は、制限モデル（変数を含まない状態）での情報から有意性を評価します。
  * モデルを完全にフィットさせる必要がないため、計算が効率的です。
  * 検定統計量はカイ二乗分布に従い、変数の数に応じた自由度で評価されます。

* P値（ログランク検定）
  * スコア統計量のP値は、予測変数の導入によってモデルが改善されるかを検定します。
  * 一般的に5%（0.05）未満であれば、統計的に有意であると判断できます。
  * P値が小さいほど、モデルに含まれる変数が有意である可能性が高いと解釈します。

* ワルド統計量
  * ワルド検定は、推定された回帰係数がゼロかどうかを評価する検定です。
  * 回帰係数をその標準誤差で割った値の二乗を統計量とします。
  * カイ二乗分布に従い、自由度は予測変数の数に等しくなります。

* P値（ワルド検定）
  * ワルド統計量に対応するP値は、個々の変数の有意性を確認するために使われます。
  * 一般的に5%（0.05）未満であれば、統計的に有意であると判断されます。
  * P値が小さいほど、モデルに含まれる変数が有意である可能性が高いと解釈します。


{start_show_hide}
## その他の指標

* 対数尤度
  * 対数尤度はモデルがデータにどれだけ適合しているかを数値化したものです。
  * 通常は負の値を取り、0に近いほどモデルの適合度が高いことを示します。
  * 単独では解釈が難しく、モデル比較のためのAICやBICの計算に使用されます。

* AIC
  * AIC（赤池情報量基準）はモデルの複雑さと適合度のバランスを評価する指標です。
  * 値が小さいほど優れたモデルとされ、過学習を防ぎながら最適なモデルを選択するのに役立ちます。
  * 同じデータセットで異なるモデルを比較する際に使用されます。

* BIC
  * BIC（ベイズ情報量基準）はAICと同様にモデル選択のための指標ですが、サンプルサイズによる補正がより厳しくなっています。
  * AICよりも単純なモデルを選ぶ傾向があり、値が小さいほど良いモデルと判断されます。
  * 大きなサンプルサイズでの分析や、真のモデルが比較的単純だと考えられる場合に有用です。

* VIF (最大値)
  * VIF（分散拡大要因）は予測変数間の多重共線性の程度を示す指標です。
  * 一般的にVIFが10以上の変数は多重共線性の問題があると判断されます。
  * 値は1以上で、1に近いほど多重共線性が少ないことを示します。

{end_show_hide}

<% if (!test_mode) { %>
## トレーニングデータに対する予測

トレーニングデータに対して、作成された予測モデルを使って予測した結果が以下の表となります。
<% } else { %>
## トレーニング・テストデータに対する予測

トレーニングデータとテストデータに対して、作成された予測モデルを使って予測した結果が以下の表となります。
<% } %>

{start_lazy_show_hide}
### 予測結果
{{data}}
{end_lazy_show_hide}

## ROC曲線

<% if (!test_mode) { %>
モデルの分類性能を様々なTRUE/FALSEの境界値で評価するROC曲線が以下のチャートです。Y軸は真陽性率（感度）、X軸は偽陽性率（1-特異度）を表しています。青い線は今回のモデルのROC曲線で、対角線の灰色の点線はランダムな予測（AUC: 0.5）を意味します。ROC曲線は左上に膨らむほど予測精度が高く、対角線に近いほど予測精度が低いことを示します。
<% } else { %>
モデルの分類性能を様々なTRUE/FALSEの境界値で評価するROC曲線が以下のチャートです。Y軸は真陽性率（感度）、X軸は偽陽性率（1-特異度）を表しています。青い線は今回のモデルのテストデータに対するROC曲線、オレンジの線はトレーニングデータに対するROC曲線です。対角線の灰色の点線はランダムな予測（AUC: 0.5）を意味します。ROC曲線は左上に膨らむほど予測精度が高く、対角線に近いほど予測精度が低いことを示します。
<% } %>

{{roc_curve}}

ROC曲線の計算には、<%= survival_period%>経過時点での生存率の予測値が使われています。期間は[「設定」](//analytics/settings/survival_period)より変更可能です。



# 補足情報

## 次のステップ

* 変数選択の最適化：統計的に有意でない変数（P値が<%= baseline_p_pct %>%以上）を除外しモデルをシンプルにすることで、モデルの解釈がしやすくなり、過剰適合のリスクも減らすことができます。変数選択のガイドラインは[こちら](https://exploratory.io/note/exploratory/SWF4cTx8)のノートをご覧ください。
<% if (!repeat_by) { %>
* グループ別分析：グループごとに別々のモデルを作成することで、それぞれのグループ内での生存曲線の決定要因をより詳細に理解できるかもしれません。その場合は、「繰り返し」にグループとなる変数を選択し、実行し直すことができます。
<% } %>
* 外れ値の確認：予測精度に影響を与える可能性のある外れ値がないか確認し、必要に応じて対処することで、モデルの信頼性が向上する可能性があります。外れ値を除去する方法については、[こちら](https://exploratory.io/note/exploratory/Eep7kip3)のノートをご覧ください。
<% if (!test_mode) { %>
* モデルの評価：このモデルの予測性能をより厳密に評価するために、トレーニングデータとテストデータに分けて検証することができます。その場合は、[「設定」](//analytics/settings/test_mode)より「検証」セクションの下の「テストモード」をTRUEに設定し、実行し直してください。
<% } %>
* 新しいデータに対する予測：作成したモデルを使って新しいデータに対して予測をしたいときには、予測をしたい対象のデータフレームに「モデルで予測（アナリティクス・ビュー）」のステップを追加します。詳細は、[こちらのノート](https://exploratory.io/note/exploratory/qIr9Hfa5)をご参照ください。

`;

module.exports = template;
