const template =
`
<br/>
<!-- intentional new line feed above -->

選択された説明変数を元に、<%= target %>を予測する決定木のモデルを作成しました。

# 変数間の関係

<% if (predictorColumns.length > 1) { %>
## 変数の重要度

<%= target %>を予測するためにどの説明変数が相対的により重要なのかを表したのが以下のチャートです。

{{variable_importance}}

<% } %>

## 変数の影響度

それぞれの説明変数の値が変わると、<%= target %>の分類ごとの確率がどのように変わるかを表したのが以下のチャートです。

{{variable_effect}}

注意点：

<% if (predictorColumns.length > 1) { %>

* 他の変数が一定だとした時に、その説明変数単体の効果を予測しているため、実測値の平均値と予測値にずれが生じます。
* 予測値の計算方法の詳細は、[こちらのノート](https://exploratory.io/note/exploratory/Sbd0LDU6)をご参照ください。
* 説明変数は上記の「説明変数の重要度」にある重要度の高い順番で並んでいます。

<% } %>
* カテゴリー型（Character型、Factor型）の説明変数において一意の値が12個より多い場合は、頻度の多いものから11個の値を残し、それ以外は「その他」としています。これは[「設定」](//analytics/settings)より変更可能です。


# 決定木

データを下に作成された決定木（一連の条件分岐）を可視化したものが以下です。<%= target %>を予測する際に作られた条件分岐を確認することができます。

{{tree_structure}}

**決定木の読み方**

それぞれの箱はノードと呼ばれ、そこから伸びる線はブランチ（枝）と呼ばれます。

- **条件分岐**: 各ノードの下には条件（例：「変数A < 値X」）が表示されており、この条件に基づいて左右に分岐します。
 - 左側のブランチは条件が「yes（真）」の場合
 - 右側のブランチは条件が「no（偽）」の場合
- **ノード内の情報**
 - **上段**: 各ノードに含まれるデータの<%= target %>の値の最頻値
 - **中段**: 各ノードに含まれるデータの<%= target %>の各値の割合
 - **下段**: 各ノードに含まれるデータの全体に対する割合（%）

 一番下のノードの上段の値とそれに対応する中断の割合が決定木のモデルを使ったさいの予測値となります。


# モデルの指標

## モデルレベルの予測精度

<% if (test_mode) { %>
モデルの予測精度に関する様々な指標を、以下の表にまとめています。現在テストモードであるため、予測精度に対してはトレーニングデータとテストデータ両方に対しての指標を表示しています。
<% } else { %>
モデルの予測精度に関する様々な指標を以下の表にまとめています。
<% } %>

{{summary}}

* 行数はモデル作成に使用したデータの行数を示します。
* 正解率、誤分類率、F1スコア、適合率、再現率はTRUE/FALSEの境界値の設定により影響されます。現在の境界値は<%= true_false_criteria %>に設定されていますが、これは[「設定」](//analytics/settings)より変更可能です。


**指標の詳細**

* F値 (マイクロ平均)
  * F値（マイクロ平均）は全てのクラスを統合して計算されたF値で、全体的な分類性能を示します。
  * 値は0から1の間で、1に近いほど全体的な予測精度が高いことを意味します。
  * 分類ごとのサンプル数の影響を受けやすく、多数派クラスの性能が強く反映されます。

* F値 (マクロ平均)
  * F値（マクロ平均）は分類ごとのF値を単純平均したもので、クラス間のバランスを考慮した分類性能を示します。
  * 値は0から1の間で、1に近いほどすべてのクラスで均等に高い予測精度を保っていることを意味します。
  * サンプル数の偏りに影響されにくく、少数派クラスの性能も平等に評価されます。

* 正解率
  * 分類ごとの正解率は、そのクラスと予測されたもののうち実際にそのクラスだった割合を示します。
  * 値は0から1の間で、1に近いほどそのクラスの予測が正確であることを意味します。
  * 全体の正解率とは異なり、クラス単位での予測精度を表します。

* 誤分類率
  * 分類ごとの誤分類率は、そのクラスと予測されたもののうち実際には違うクラスだった割合を示します。
  * 値は0から1の間で、0に近いほどそのクラスの誤分類が少ないことを意味します。
  * 1-正解率で計算され、クラス単位での予測エラー率を表します。


## グループごとの予測精度

グループごとの予測精度を示したのが以下の表です。

{{class_summary}}

* 正解率、誤分類率、F1スコア、適合率、再現率はTRUE/FALSEの境界値の設定により影響されます。現在の境界値は<%= true_false_criteria %>に設定されていますが、これは[「設定」](//analytics/settings)より変更可能です。

{start_show_hide}
### 指標の詳細

* F1スコア
    * F1スコアは分類ごとの適合率と再現率の調和平均で、そのクラスに対する分類性能の総合指標です。
    * 値は0から1の間で、1に近いほどそのクラスの予測精度が高いことを意味します。
    * クラス不均衡がある場合でも、分類ごとの性能を適切に評価できます。

* 正解率
    * 分類ごとの正解率は、そのクラスと予測されたもののうち実際にそのクラスだった割合を示します。
    * 値は0から1の間で、1に近いほどそのクラスの予測が正確であることを意味します。
    * 全体の正解率とは異なり、クラス単位での予測精度を表します。

* 誤分類率
    * 分類ごとの誤分類率は、そのクラスと予測されたもののうち実際には違うクラスだった割合を示します。
    * 値は0から1の間で、0に近いほどそのクラスの誤分類が少ないことを意味します。
    * 1-正解率で計算され、クラス単位での予測エラー率を表します。

* 適合率
    * 適合率は「そのクラスと予測したもののうち、実際にそのクラスだった割合」を示します。
    * 値は0から1の間で、1に近いほど「そのクラスと予測したものが実際にそのクラスである精度」が高いことを意味します。
    * 偽陽性（実際は違うクラスなのにそのクラスと予測）を最小化したい場合に重視される指標です。

* 再現率
    * 再現率は「実際にそのクラスであるもののうち、そのクラスと正しく予測できた割合」を示します。
    * 値は0から1の間で、1に近いほど「実際のそのクラスのケースを見逃さない能力」が高いことを意味します。
    * 偽陰性（実際はそのクラスなのに違うクラスと予測）を最小化したい場合に重視される指標です。

{end_show_hide}




## 予測マトリックス（混同行列）

<% if (!test_mode) { %>
モデルが<%= mode %>データの各行に対して予測したうち、どれだけが実測値と同じまたは違った値だったのかを対応表としてまとめたのが以下の表です。数値はそれぞれの組み合わせが全データに占める割合（％）です。
<% } else { %>
モデルが<%= mode %>データの各行に対して予測したうち、どれだけが実測値と同じまたは違った値だったのかを対応表としてまとめたのが以下の表です。数値はそれぞれの組み合わせが全データに占める割合（％）です。現在テストモードであるため、トレーニングデータ、テストデータそれぞれに対する結果を表示しています。
<% } %>

{{confusion_matrix}}

## 予測結果

全データに対して、作成された予測モデルを使って予測した結果が以下の表となります。

{start_lazy_show_hide}
### テーブル
{{data}}
{end_lazy_show_hide}

# 補足情報

## 次のステップ

* 変数選択の最適化：変数重要度が低い説明変数を除外して、モデルをシンプルにすることを検討してください。これにより、モデルの解釈がしやすくなり、過剰適合のリスクも減少します。
* グループ別分析：グループごとに別々のモデルを作成することで、それぞれのグループ内での<%= target %>の決定要因をより詳細に理解できるかもしれません。その場合は、「繰り返し」にグループとなる変数を選択し、実行し直すことができます。
* 外れ値の確認：予測精度に影響を与える可能性のある外れ値がないか確認し、必要に応じて対処することで、モデルの信頼性が向上する可能性があります。
* アンサンブル学習の手法の検討：単一の決定木では捉えられないパターンを捉えるために、ランダムフォレストやXGBoostといったアンサンブル学習の手法を検討することも有効かもしれません。
<% if (!test_mode) { %>
* モデルの評価：このモデルの予測性能をより厳密に評価するために、トレーニングデータとテストデータに分けて検証することができます。その場合は、[「設定」](//analytics/settings)より「検証」セクションの下の「テストモード」をTRUEに設定し、実行し直してください。
<% } %>

`;
module.exports = template;
